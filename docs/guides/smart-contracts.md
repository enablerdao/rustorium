# スマートコントラクト管理ガイド

Rustoriumでのスマートコントラクトのデプロイ、呼び出し、管理方法について説明します。

## スマートコントラクト機能の概要

Rustoriumは、基本的なスマートコントラクト機能をサポートしています。現在実装されている機能は以下の通りです：

- コントラクトのデプロイ
- コントラクトの呼び出し
- コントラクト情報の取得
- コントラクト状態の管理

## APIエンドポイント

### コントラクトのデプロイ

```
POST /contracts
```

**リクエスト例**:
```json
{
  "from": "0x1234567890abcdef1234567890abcdef12345678",
  "bytecode": "608060405234801561001057600080fd5b50610150806100206000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c80632e64cec11461003b5780636057361d14610059575b600080fd5b610043610075565b60405161005091906100a1565b60405180910390f35b610073600480360381019061006e91906100ed565b61007e565b005b60008054905090565b8060008190555050565b6000819050919050565b61009b81610088565b82525050565b60006020820190506100b66000830184610092565b92915050565b600080fd5b6100ca81610088565b81146100d557600080fd5b50565b6000813590506100e7816100c1565b92915050565b600060208284031215610103576101026100bc565b5b6000610111848285016100d8565b9150509291505056fea2646970667358221220ec5ef79ea9c3f806626466c24f736c1a5a5e3b8bc2fb7c814fa4ecc6ff3a9c4d64736f6c63430008120033",
  "abi": [...],
  "gas_limit": 1000000,
  "gas_price": 10
}
```

**レスポンス例**:
```json
{
  "success": true,
  "data": {
    "address": "0x1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b",
    "transaction_id": "0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890",
    "gas_used": 1000000,
    "gas_cost": 0.01
  },
  "error": null
}
```

### コントラクトの呼び出し

```
POST /contracts/{address}/call
```

**リクエスト例**:
```json
{
  "from": "0x1234567890abcdef1234567890abcdef12345678",
  "method": "store",
  "args": "42",
  "gas_limit": 100000,
  "gas_price": 10,
  "value": 0
}
```

**レスポンス例**:
```json
{
  "success": true,
  "data": {
    "transaction_id": "0x0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef",
    "result": "success",
    "gas_used": 100000
  },
  "error": null
}
```

### コントラクト情報の取得

```
GET /contracts/{address}
```

**レスポンス例**:
```json
{
  "success": true,
  "data": {
    "address": "0x1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b",
    "creator": "0x1234567890abcdef1234567890abcdef12345678",
    "bytecode": "608060405234801561001057600080fd5b50610150806100206000396000f3fe...",
    "abi": [...],
    "creation_transaction": "0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890",
    "creation_block": 10,
    "state": {
      "store": "42"
    },
    "created_at": "2025-03-19T00:00:00Z",
    "last_activity": "2025-03-19T00:05:00Z"
  },
  "error": null
}
```

## サンプルコントラクト

### SimpleStorage

以下は、値を保存して取得する簡単なコントラクトの例です：

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract SimpleStorage {
    uint256 private value;
    
    // 値を設定する関数
    function store(uint256 newValue) public {
        value = newValue;
    }
    
    // 値を取得する関数
    function retrieve() public view returns (uint256) {
        return value;
    }
}
```

## テストスクリプト

`examples`ディレクトリには、スマートコントラクトをテストするためのスクリプトが含まれています：

```bash
cd examples
./test_contract.sh
```

このスクリプトは、SimpleStorageコントラクトをデプロイし、値を保存して取得するデモを実行します。

## スマートコントラクトの表示

### コントラクトリストの表示

デプロイされたスマートコントラクトのリストを表示するには、サイドバーの「Smart Contracts」をクリックします。

![コントラクトリスト](../images/contracts-list.png)

コントラクトリストには以下の情報が表示されます：

- **アドレス**: コントラクトの一意のアドレス
- **名前**: コントラクトの名前（設定されている場合）
- **作成者**: コントラクトをデプロイしたアドレス
- **作成日時**: コントラクトがデプロイされた日時
- **トランザクション数**: コントラクトが関与したトランザクションの数
- **検証状態**: コントラクトのソースコードが検証されているかどうか

### コントラクト詳細の表示

特定のコントラクトの詳細を表示するには、コントラクトリストからアドレスをクリックします。

![コントラクト詳細](../images/contract-details.png)

コントラクト詳細ページには以下の情報が表示されます：

#### 基本情報

- **アドレス**: コントラクトの一意のアドレス
- **名前**: コントラクトの名前（設定されている場合）
- **作成者**: コントラクトをデプロイしたアドレス
- **作成トランザクション**: コントラクトをデプロイしたトランザクションID
- **作成日時**: コントラクトがデプロイされた日時
- **残高**: コントラクトの現在の残高

#### コード情報

- **バイトコード**: コントラクトのバイトコード
- **ABI**: コントラクトのABI（Application Binary Interface）
- **ソースコード**: 検証されている場合はソースコード
- **コンパイラバージョン**: コントラクトのコンパイルに使用されたコンパイラのバージョン
- **最適化設定**: コンパイル時の最適化設定

#### インタラクション

コントラクトの関数を呼び出すためのインターフェースが表示されます。関数の種類（読み取り専用、状態変更）ごとにグループ化されています。

#### イベントログ

コントラクトから発行されたイベントのログが表示されます。

#### トランザクション履歴

コントラクトが関与したトランザクションのリストが表示されます。

## スマートコントラクトのデプロイ

新しいスマートコントラクトをデプロイするには、以下の手順に従います：

1. サイドバーの「Smart Contracts」をクリックします
2. 「Deploy Contract」ボタンをクリックします

![コントラクトデプロイ](../images/deploy-contract.png)

### ソースコードからのデプロイ

1. 「Source Code」タブを選択します
2. コントラクト言語（Solidity、Vyperなど）を選択します
3. ソースコードを入力または貼り付けます
4. コンパイラバージョンを選択します
5. 必要に応じて最適化設定を調整します
6. コンストラクタ引数を入力します（必要な場合）
7. デプロイに使用するアカウントを選択します
8. ガス上限とガス価格を設定します
9. 「Deploy」ボタンをクリックします

### バイトコードからのデプロイ

1. 「Bytecode」タブを選択します
2. バイトコードを入力または貼り付けます
3. ABIを入力します（オプション）
4. コンストラクタ引数を入力します（必要な場合）
5. デプロイに使用するアカウントを選択します
6. ガス上限とガス価格を設定します
7. 「Deploy」ボタンをクリックします

## スマートコントラクトの呼び出し

コントラクトの関数を呼び出すには、コントラクト詳細ページの「Interact」タブを使用します。

![コントラクト呼び出し](../images/contract-interaction.png)

### 読み取り関数の呼び出し

1. 「Read Functions」セクションから呼び出したい関数を選択します
2. 必要なパラメータを入力します
3. 「Call」ボタンをクリックします
4. 関数の戻り値が表示されます

### 書き込み関数の呼び出し

1. 「Write Functions」セクションから呼び出したい関数を選択します
2. 必要なパラメータを入力します
3. 送信する金額を入力します（payable関数の場合）
4. 呼び出しに使用するアカウントを選択します
5. ガス上限とガス価格を設定します
6. 「Execute」ボタンをクリックします
7. トランザクションが送信され、結果が表示されます

## コントラクトの検証

コントラクトのソースコードを検証するには、以下の手順に従います：

1. コントラクト詳細ページで「Verify & Publish」ボタンをクリックします
2. コントラクト言語（Solidity、Vyperなど）を選択します
3. コンパイラバージョンを選択します
4. 最適化設定を選択します
5. ソースコードを入力または貼り付けます
6. 「Verify」ボタンをクリックします

検証が成功すると、コントラクトのソースコードが公開され、誰でも閲覧できるようになります。

## コントラクトのインポート

既存のコントラクトをインポートするには、以下の手順に従います：

1. サイドバーの「Smart Contracts」をクリックします
2. 「Import Contract」ボタンをクリックします
3. コントラクトアドレスを入力します
4. ABIを入力します（オプション）
5. コントラクト名を入力します（オプション）
6. 「Import」ボタンをクリックします

## コントラクトの監視

特定のコントラクトを監視するには、コントラクト詳細ページの「Watch」ボタンをクリックします。コントラクトのイベントやトランザクションに変更があると通知が表示されます。

## コントラクト情報のエクスポート

コントラクト情報をCSV、JSON、またはPDFフォーマットでエクスポートできます。エクスポートするには、コントラクトリストまたはコントラクト詳細ページの「Export」ボタンをクリックします。

## 高度な機能

### コントラクトライブラリ

頻繁に使用するコントラクトをライブラリに保存できます。ライブラリに追加するには、コントラクト詳細ページの「Add to Library」ボタンをクリックします。

### コントラクトテンプレート

新しいコントラクトをデプロイする際に、テンプレートを使用できます。テンプレートを使用するには、デプロイページの「Templates」セクションからテンプレートを選択します。

### バッチトランザクション

複数のコントラクト呼び出しを1つのトランザクションにまとめることができます。バッチトランザクションを作成するには、「Batch Transactions」機能を使用します。

## セキュリティのベストプラクティス

スマートコントラクトのセキュリティを確保するために、以下のベストプラクティスを推奨します：

1. **コードの監査**: デプロイ前にコードの監査を行い、脆弱性がないことを確認してください
2. **テストの実施**: 本番環境にデプロイする前に、テストネットで十分なテストを行ってください
3. **ガス最適化**: ガス使用量を最適化し、不必要なコストを削減してください
4. **アクセス制御**: 適切なアクセス制御を実装し、権限のない操作を防止してください
5. **イベントの発行**: 重要な状態変更時にはイベントを発行し、トレーサビリティを確保してください